name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    # Run on PR events or when @claude is mentioned in comments
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
          else
            PR_NUMBER=${{ github.event.issue.number }}
          fi

          # Fetch the diff
          gh pr diff $PR_NUMBER > pr_diff.txt

          # Get PR details
          gh pr view $PR_NUMBER --json title,body,files --jq '{title: .title, body: .body, files: [.files[].path]}' > pr_details.json

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Review with Claude
        id: review
        run: |
          # Read PR details
          PR_TITLE=$(jq -r '.title' pr_details.json)
          PR_BODY=$(jq -r '.body // "No description provided"' pr_details.json)
          CHANGED_FILES=$(jq -r '.files | join(", ")' pr_details.json)
          DIFF=$(cat pr_diff.txt | head -c 100000)  # Limit diff size

          # Prepare the review prompt
          PROMPT=$(cat << 'PROMPT_EOF'
          You are a code reviewer for the awesome-slash project. Review this pull request and provide constructive feedback.

          Focus on:
          1. Code correctness and potential bugs
          2. Security vulnerabilities
          3. Performance concerns
          4. Code style and best practices
          5. Test coverage

          Be concise but thorough. If the code looks good, say so briefly.
          Format your response as markdown suitable for a GitHub PR comment.
          Start with a brief summary, then list specific issues if any.
          PROMPT_EOF
          )

          # Build the message payload
          MESSAGE_CONTENT="# PR Review Request

          **Title:** $PR_TITLE

          **Description:**
          $PR_BODY

          **Changed Files:** $CHANGED_FILES

          **Diff:**
          \`\`\`diff
          $DIFF
          \`\`\`"

          # Call Claude API directly (Anthropic, not Bedrock)
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "$(jq -n \
              --arg model "claude-sonnet-4-20250514" \
              --arg system "$PROMPT" \
              --arg content "$MESSAGE_CONTENT" \
              '{
                model: $model,
                max_tokens: 4096,
                system: $system,
                messages: [{role: "user", content: $content}]
              }')")

          # Extract the review text
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "Error: Could not get review from Claude"')

          # Save review for next step
          echo "$REVIEW" > review_output.md
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Post review comment
        run: |
          PR_NUMBER=${{ steps.diff.outputs.pr_number }}
          REVIEW=$(cat review_output.md)

          # Add Claude signature
          COMMENT="## Claude Review

          $REVIEW

          ---
          *Reviewed by Claude (Anthropic API)*"

          # Post comment to PR
          gh pr comment $PR_NUMBER --body "$COMMENT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
